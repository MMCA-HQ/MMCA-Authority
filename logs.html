<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>لوحة الرئيس | دولة مارفل</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root {
            --army: #3d4921;
            --gold: #c5a059;
            --dark-bg: #0b0c08;
            --panel-bg: #14160f;
            --input-bg: #000000;
            --border: #1a1d12;
            --error: #e74c3c;
            --blue: #3498db;
            --green: #2ecc71;
        }

        body {
            background: var(--dark-bg);
            color: #fff;
            font-family: 'Segoe UI', Tahoma, sans-serif;
            margin: 0;
            padding: 20px;
            display: none; /* مخفي حتى إدخال كلمة المرور */
        }

        .container { max-width: 1100px; margin: 0 auto; }

        .panel {
            background: var(--panel-bg);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        h2 {
            color: var(--gold);
            font-size: 1.4rem;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        h2::after {
            content: "|";
            color: var(--gold);
            margin-right: 15px;
            font-weight: bold;
            font-size: 2rem;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-direction: row-reverse;
        }

        input, textarea, select {
            background: var(--input-bg);
            color: #fff;
            border: 1px solid var(--border);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            flex: 1;
        }

        .btn-gold {
            background: var(--gold);
            color: #000;
            border: none;
            padding: 0 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            min-width: 120px;
        }

        .btn-edit { background: var(--blue); color: #fff; padding: 5px 10px; border-radius: 5px; border: none; cursor: pointer; font-size: 0.8rem; }
        .btn-del { background: var(--error); color: #fff; padding: 5px 10px; border-radius: 5px; border: none; cursor: pointer; font-size: 0.8rem; }
        .btn-save { background: var(--green); color: #fff; padding: 5px 10px; border-radius: 5px; border: none; cursor: pointer; font-size: 0.8rem; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; direction: rtl; }
        th { color: var(--gold); padding: 15px; border-bottom: 1px solid var(--border); text-align: center; font-size: 0.9rem; }
        td { padding: 15px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); }

        .section-red { border: 1px solid var(--error); }
    </style>
</head>
<body>

<div class="container">
    <h1 style="text-align: center; color: var(--gold); margin-bottom: 50px;">نظام التحكم الأعلى | دولة مارفل</h1>

    <div class="panel">
        <h2>إدارة الشروط والضوابط</h2>
        <textarea id="rulesText" style="width: 100%; height: 100px; margin-bottom: 15px;" placeholder="اكتب الشروط هنا..."></textarea>
        <button class="btn-gold" style="width: 100%; height: 50px;" onclick="saveRules()">تحديث الشروط</button>
    </div>

    <div class="panel">
        <h2>إدارة الدورات والمواعيد</h2>
        <div class="controls">
            <input type="text" id="c_name" placeholder="اسم الدورة">
            <input type="text" id="c_p1" placeholder="الفترة 1">
            <input type="text" id="c_p2" placeholder="الفترة 2">
            <input type="hidden" id="edit_c_id">
            <button class="btn-gold" id="btn_c" onclick="addOrUpdateCourse()">حفظ جديد</button>
        </div>
        <table>
            <thead><tr><th>التحكم</th><th>فترة 2</th><th>فترة 1</th><th>الدورة</th></tr></thead>
            <tbody id="t_courses"></tbody>
        </table>
    </div>

    <div class="panel">
        <h2>روابط الاختبارات</h2>
        <div class="controls">
            <input type="text" id="e_name" placeholder="اسم الدورة">
            <input type="text" id="e_url" placeholder="رابط الاختبار">
            <input type="hidden" id="edit_e_id">
            <button class="btn-gold" id="btn_e" onclick="addItem('exams', 'e_name', 'e_url', 'edit_e_id', 'btn_e')">حفظ جديد</button>
        </div>
        <table><thead><tr><th>التحكم</th><th>الرابط</th><th>الدورة</th></tr></thead><tbody id="t_exams"></tbody></table>
    </div>

    <div class="panel">
        <h2>روابط التصحيح</h2>
        <div class="controls">
            <input type="text" id="co_name" placeholder="اسم الدورة">
            <input type="text" id="co_url" placeholder="رابط التصحيح">
            <input type="hidden" id="edit_co_id">
            <button class="btn-gold" id="btn_co" onclick="addItem('correction', 'co_name', 'co_url', 'edit_co_id', 'btn_co')">حفظ جديد</button>
        </div>
        <table><thead><tr><th>التحكم</th><th>الرابط</th><th>الدورة</th></tr></thead><tbody id="t_correction"></tbody></table>
    </div>

    <div class="panel">
        <h2>استبيانات الدورات</h2>
        <div class="controls">
            <input type="text" id="s_name" placeholder="اسم الدورة">
            <input type="text" id="s_url" placeholder="رابط الاستبيان">
            <input type="hidden" id="edit_s_id">
            <button class="btn-gold" id="btn_s" onclick="addItem('surveys', 's_name', 's_url', 'edit_s_id', 'btn_s')">حفظ جديد</button>
        </div>
        <table><thead><tr><th>التحكم</th><th>الرابط</th><th>الدورة</th></tr></thead><tbody id="t_surveys"></tbody></table>
    </div>

    <div class="panel section-red">
        <h2>إدارة شؤون المتقدمين</h2>
        <div class="controls">
            <input type="text" id="app_name" placeholder="الاسم">
            <input type="text" id="app_code" placeholder="الكود">
            <input type="hidden" id="edit_app_id">
            <button class="btn-gold" id="btn_app" onclick="addOrUpdateApp()">إضافة عضو يدوي</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>الاسم</th>
                    <th>الكود</th>
                    <th>حالة القبول</th>
                    <th>حالة النتائج</th>
                    <th>الإجراء النهائي</th>
                </tr>
            </thead>
            <tbody id="t_apps"></tbody>
        </table>
    </div>
</div>

<script>
    // 1. الأمان
    const p = prompt("أدخل كلمة المرور:");
    if(p === "رئيس_2026") { document.body.style.display = "block"; } else { alert("خطأ!"); window.location.href="about:blank"; }

    // 2. Firebase
    const firebaseConfig = { apiKey: "AIzaSyAALZ-v8wA_5mjUVSqW1uLXMwMkskpDaGM", databaseURL: "https://mmca-authority-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 3. وظائف الحفظ
    function saveRules() { db.ref('authority_data/rules').set(document.getElementById('rulesText').value).then(()=>alert("تم التحديث")); }

    function addOrUpdateCourse() {
        const id = document.getElementById('edit_c_id').value;
        const data = { name: document.getElementById('c_name').value, p1: document.getElementById('c_p1').value, p2: document.getElementById('c_p2').value };
        if(id) db.ref('authority_data/courses/'+id).update(data); else db.ref('authority_data/courses').push(data);
        resetF(['edit_c_id','c_name','c_p1','c_p2'], 'btn_c');
    }

    function addOrUpdateApp() {
        const id = document.getElementById('edit_app_id').value;
        const data = { name: document.getElementById('app_name').value, code: document.getElementById('app_code').value };
        if(id) db.ref('applications/'+id).update(data); else db.ref('applications').push(data);
        resetF(['edit_app_id','app_name','app_code'], 'btn_app');
    }

    // وظائف التحكم المباشر بالحالات
    function updateAppStatus(id, field, val) {
        let update = {};
        update[field] = val;
        db.ref('applications/' + id).update(update);
    }

    function removeAppField(id, field) {
        db.ref('applications/' + id + '/' + field).remove();
    }

    function deleteApp(id) {
        if(confirm("هل أنت متأكد من حذف هذا المتقدم نهائياً؟")) {
            db.ref('applications/' + id).remove();
        }
    }

    function addItem(path, ni, ui, hi, bi) {
        const id = document.getElementById(hi).value;
        const data = { course: document.getElementById(ni).value, url: document.getElementById(ui).value };
        if(id) db.ref('authority_data/'+path+'/'+id).update(data); else db.ref('authority_data/'+path).push(data);
        resetF([hi, ni, ui], bi);
    }

    function resetF(ids, b) { ids.forEach(id=>document.getElementById(id).value=""); document.getElementById(b).innerText="حفظ جديد"; }

    // 4. عرض البيانات (المزامنة)
    db.ref().on('value', snap => {
        const d = snap.val() || {};
        const auth = d.authority_data || {};
        document.getElementById('rulesText').value = auth.rules || "";

        // الدورات
        let hC = ""; for(let i in auth.courses) { let c = auth.courses[i]; hC += `<tr><td><button class="btn-edit" onclick="setEC('${i}','${c.name}','${c.p1}','${c.p2}')">تعديل</button><button class="btn-del" onclick="db.ref('authority_data/courses/${i}').remove()">حذف</button></td><td>${c.p2}</td><td>${c.p1}</td><td>${c.name}</td></tr>`; }
        document.getElementById('t_courses').innerHTML = hC;

        // المتقدمين (الجدول المعدل)
        let hA = ""; 
        for(let i in d.applications) { 
            let a = d.applications[i]; 
            hA += `<tr>
                <td>${a.name}</td>
                <td>${a.code}</td>
                <td>
                    <select onchange="updateAppStatus('${i}', 'status', this.value)">
                        <option value="" ${!a.status ? 'selected' : ''}>-- معلق --</option>
                        <option value="مقبول" ${a.status === 'مقبول' ? 'selected' : ''}>مقبول</option>
                        <option value="مرفوض" ${a.status === 'مرفوض' ? 'selected' : ''}>مرفوض</option>
                    </select>
                    <button class="btn-del" style="margin-top:5px" onclick="removeAppField('${i}', 'status')">حذف الحالة</button>
                </td>
                <td>
                    <select onchange="updateAppStatus('${i}', 'pass', this.value)">
                        <option value="" ${!a.pass ? 'selected' : ''}>-- لا يوجد --</option>
                        <option value="ناجح" ${a.pass === 'ناجح' ? 'selected' : ''}>ناجح</option>
                        <option value="راسب" ${a.pass === 'راسب' ? 'selected' : ''}>راسب</option>
                    </select>
                    <button class="btn-del" style="margin-top:5px" onclick="removeAppField('${i}', 'pass')">حذف النتيجة</button>
                </td>
                <td>
                    <button class="btn-del" onclick="deleteApp('${i}')">حذف نهائي</button>
                </td>
            </tr>`; 
        }
        document.getElementById('t_apps').innerHTML = hA;

        // الروابط والاستبيانات
        const sec = { exams: 't_exams', correction: 't_correction', surveys: 't_surveys' };
        for(let s in sec) {
            let h = ""; for(let i in auth[s]) { let it = auth[s][i]; h += `<tr><td><button class="btn-edit" onclick="setEI('${s}','${i}','${it.course}','${it.url}')">تعديل</button><button class="btn-del" onclick="db.ref('authority_data/${s}/${i}').remove()">حذف</button></td><td style="color:var(--gold); font-size:0.8rem;">${it.url}</td><td>${it.course}</td></tr>`; }
            document.getElementById(sec[s]).innerHTML = h;
        }
    });

    // 5. تعبئة بيانات التعديل
    function setEC(id,n,p1,p2) { document.getElementById('edit_c_id').value=id; document.getElementById('c_name').value=n; document.getElementById('c_p1').value=p1; document.getElementById('c_p2').value=p2; document.getElementById('btn_c').innerText="تحديث"; }
    function setEI(s,id,n,u) {
        const m = { exams: ['edit_e_id','e_name','e_url','btn_e'], correction: ['edit_co_id','co_name','co_url','btn_co'], surveys: ['edit_s_id','s_name','s_url','btn_s'] };
        document.getElementById(m[s][0]).value=id; document.getElementById(m[s][1]).value=n; document.getElementById(m[s][2]).value=u; document.getElementById(m[s][3]).innerText="تحديث";
    }
</script>
</body>
</html>
