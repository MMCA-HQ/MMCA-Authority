<script>
    const firebaseConfig = { apiKey: "AIzaSyAALZ-v8wA_5mjUVSqW1uLXMwMkskpDaGM", databaseURL: "https://mmca-authority-default-rtdb.firebaseio.com" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function updatePeriods() {
        const courseName = document.getElementById('regCourse').value;
        db.ref('authority_data/courses').once('value', snap => {
            const courses = snap.val();
            let options = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„ÙØªØ±Ø© --</option>';
            for(let id in courses) {
                if(courses[id].name === courseName) {
                    if(courses[id].p1) options += `<option value="${courses[id].p1}">${courses[id].p1}</option>`;
                    if(courses[id].p2) options += `<option value="${courses[id].p2}">${courses[id].p2}</option>`;
                }
            }
            document.getElementById('regPeriod').innerHTML = options;
        });
    }

    function submitApplication() {
        const fields = { name: document.getElementById('regName').value, code: document.getElementById('regCode').value, age: document.getElementById('regAge').value, course: document.getElementById('regCourse').value, period: document.getElementById('regPeriod').value };
        if(!fields.name || !fields.code || !fields.course || !fields.period) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        db.ref('applications').push({...fields, status: 'ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©', pass: 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯ÙˆØ±Ø©'}).then(() => { 
            // Ø¥Ø±Ø³Ø§Ù„ Ù„ÙˆÙ‚ Ø¹Ù†Ø¯ Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…
            db.ref('authority_data/logs').push({ msg: `ğŸ“© ØªÙ‚Ø¯Ù… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…: ${fields.name} ÙƒÙˆØ¯: ${fields.code}`, time: new Date().toLocaleString('ar-SA') });
            alert("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„"); 
        });
    }

    db.ref().on('value', (snap) => {
        const data = snap.val() || {}; const auth = data.authority_data || {}; const apps = data.applications || {};
        document.getElementById('rulesDisplay').innerText = auth.rules || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±ÙˆØ·";
        let cHtml = ""; let selHtml = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ±Ø© --</option>';
        for(let id in auth.courses) {
            const c = auth.courses[id];
            cHtml += `<tr><td>${c.name}</td><td>${c.p1}</td><td>${c.p2}</td></tr>`;
            selHtml += `<option value="${c.name}">${c.name}</option>`;
        }
        document.getElementById('coursesTable').innerHTML = cHtml;
        document.getElementById('regCourse').innerHTML = selHtml;
        let accHtml = ""; let passHtml = "";
        for(let id in apps) {
            const a = apps[id];
            accHtml += `<tr><td>${a.name}</td><td>${a.code}</td><td>${a.course}</td><td>${a.period || '-'}</td><td class="${a.status==='Ù…Ù‚Ø¨ÙˆÙ„'?'status-accepted':(a.status==='Ù…Ø±ÙÙˆØ¶'?'status-rejected':'status-pending')}">${a.status}</td></tr>`;
            if(a.status === 'Ù…Ù‚Ø¨ÙˆÙ„') {
                let pClass = "pass-waiting"; let pText = a.pass || "Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±";
                if(a.pass === 'Ù†Ø§Ø¬Ø­' || a.pass === 'ØªÙ… Ø§Ù„Ø§Ø¬ØªÙŠØ§Ø²') { pClass = "pass-success"; pText = "Ø§Ø¬ØªÙŠØ§Ø² âœ“"; }
                if(a.pass === 'Ø±Ø§Ø³Ø¨' || a.pass === 'Ø¹Ø¯Ù… Ø§Ø¬ØªÙŠØ§Ø²') { pClass = "pass-failed"; pText = "Ø¹Ø¯Ù… Ø§Ø¬ØªÙŠØ§Ø² âœ—"; }
                passHtml += `<tr><td>${a.name}</td><td>${a.code}</td><td>${a.course}</td><td><span class="${pClass}">${pText}</span></td></tr>`;
            }
        }
        document.getElementById('accBody').innerHTML = accHtml;
        document.getElementById('passBody').innerHTML = passHtml;
    });
</script>
